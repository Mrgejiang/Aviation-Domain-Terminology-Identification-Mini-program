"use strict";const t=require("../../common/vendor.js"),e=require("../../common/assets.js"),s={data:()=>({messages:[],inputText:"",lastMsgId:"",botInfo:{name:"",icon_url:"",description:"",suggestedQuestions:[]},inputPlaceholder:"请输入您的问题",isLoading:!1,showSuggested:!0,conversationId:null}),created(){this.initBotInfo()},methods:{async initBotInfo(){try{const e=await t.index.request({url:"https://api.coze.cn/v1/bot/get_online_info?bot_id=7461239179847172122",method:"GET",header:{Authorization:"Bearer pat_6yySAkMrimmjkwJMfE8lfuUtJzJnwSwjYj34ACUZMIK21fFuWad3a91NvYuDl77s","Content-Type":"application/json"}});if(0===e.data.code){const t=e.data.data;this.botInfo={name:t.name,icon_url:t.icon_url,description:t.description,suggestedQuestions:t.onboarding_info.suggested_questions},this.messages.push({type:"ai",content:t.onboarding_info.prologue,time:this.getCurrentTime()});const s=t.prompt_info.prompt.match(/请输入(.*?)\n/);this.inputPlaceholder=s?s[1]:"请输入您的问题"}}catch(e){console.error("初始化失败:",e)}},async getAIResponse(e){try{const s=(await t.index.request({url:"https://api.coze.cn/open_api/v2/chat",method:"POST",header:{Authorization:"Bearer pat_6yySAkMrimmjkwJMfE8lfuUtJzJnwSwjYj34ACUZMIK21fFuWad3a91NvYuDl77s","Content-Type":"application/json"},data:{bot_id:"7461239179847172122",user:"uni-app-user",query:e,stream:!1}})).data;if(console.log("API返回数据:",s),0!==s.code)throw new Error(s.msg||"API返回错误");const n=s.messages.find((t=>"answer"===t.type));if(!n)throw new Error("未找到回答内容");const o=s.messages.filter((t=>"follow_up"===t.type)).map((t=>t.content));return o.length>0&&(this.botInfo.suggestedQuestions=o,this.showSuggested=!0),{content:n.content}}catch(s){throw console.error("API请求失败:",s),new Error(`请求失败：${s.message}`)}},async sendMessage(){if(!this.inputText.trim()||this.isLoading)return;this.showSuggested=!1;const t={type:"user",content:this.inputText,time:this.getCurrentTime()};this.messages.push(t);const e={type:"ai",content:"",time:this.getCurrentTime()};this.messages.push(e);const s=this.inputText;this.inputText="",this.isLoading=!0;try{const t=await this.getAIResponse(s);e.content=t.content}catch(n){e.content=`请求失败：${n.message||"网络异常，请稍后重试"}`}this.isLoading=!1,this.scrollToBottom()},sendSuggested(t){this.inputText=t,this.sendMessage()},getCurrentTime(){const t=new Date;return`${t.getHours()}:${t.getMinutes().toString().padStart(2,"0")}`},scrollToBottom(){this.$nextTick((()=>{this.lastMsgId="msg"+(this.messages.length-1)}))}}};const n=t._export_sfc(s,[["render",function(s,n,o,i,a,r){return t.e({a:a.botInfo.icon_url,b:t.t(a.botInfo.name),c:t.t(a.botInfo.description),d:t.f(a.messages,((s,n,o)=>t.e({a:"ai"===s.type},"ai"===s.type?{b:a.botInfo.icon_url}:{},{c:"ai"===s.type},"ai"===s.type?{d:t.t(a.botInfo.name)}:{},{e:t.t(s.content),f:t.t(s.time),g:"user"===s.type},"user"===s.type?{h:e._imports_0}:{},{i:n,j:"msg"+n,k:t.n(s.type)}))),e:a.showSuggested},a.showSuggested?{f:t.f(a.botInfo.suggestedQuestions,((e,s,n)=>({a:t.t(e),b:"q"+s,c:t.o((t=>r.sendSuggested(e)),"q"+s)})))}:{},{g:a.lastMsgId,h:a.inputPlaceholder,i:t.o(((...t)=>r.sendMessage&&r.sendMessage(...t))),j:a.inputText,k:t.o((t=>a.inputText=t.detail.value)),l:t.t(a.isLoading?"思考中...":"发送"),m:t.o(((...t)=>r.sendMessage&&r.sendMessage(...t))),n:a.isLoading})}]]);wx.createPage(n);
